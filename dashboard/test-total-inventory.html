<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Test Total Inventory - T·ªïng t·ªìn kho t·ª´ t·∫•t c·∫£ chi nh√°nh</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { color: #2563eb; }
    h2 { color: #1e40af; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb; }
    h3 { color: #3b82f6; margin-top: 20px; }
    button { background: #2563eb; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-right: 10px; margin-bottom: 10px; }
    button:hover { background: #1d4ed8; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    pre { background: #1f2937; color: #f3f4f6; padding: 16px; border-radius: 6px; overflow-x: auto; max-height: 400px; overflow-y: auto; font-size: 12px; }
    .error { background: #fee2e2; border: 1px solid #ef4444; color: #991b1b; padding: 12px; border-radius: 6px; }
    .success { background: #d1fae5; border: 1px solid #10b981; color: #065f46; padding: 12px; border-radius: 6px; }
    .warning { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; padding: 12px; border-radius: 6px; margin-top: 10px; }
    .info { background: #dbeafe; border: 1px solid #3b82f6; color: #1e3a8a; padding: 12px; border-radius: 6px; margin: 10px 0; }
    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin: 20px 0; }
    .stat-card { background: #eff6ff; border: 2px solid #3b82f6; padding: 16px; border-radius: 8px; }
    .stat-label { font-size: 14px; color: #1e40af; font-weight: 600; }
    .stat-value { font-size: 28px; color: #1e3a8a; font-weight: bold; margin-top: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 13px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; }
    th { background: #f9fafb; font-weight: 600; color: #374151; position: sticky; top: 0; }
    tr:hover { background: #f9fafb; }
    .stock-zero { color: #dc2626; font-weight: bold; }
    .stock-ok { color: #16a34a; font-weight: bold; }
    .loading { text-align: center; padding: 40px; }
    .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .table-container { max-height: 600px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Test Total Inventory - T·ªïng t·ªìn kho t·ª´ t·∫•t c·∫£ chi nh√°nh</h1>
    <p>Ki·ªÉm tra c√°ch t√≠nh t·ªïng t·ªìn kho c·ªßa m·ªói s·∫£n ph·∫©m b·∫±ng c√°ch c·ªông t·ª´ t·∫•t c·∫£ c√°c chi nh√°nh</p>
    
    <div class="info">
      <strong>üìã Quy tr√¨nh test:</strong><br>
      1Ô∏è‚É£ L·∫•y danh s√°ch t·∫•t c·∫£ chi nh√°nh<br>
      2Ô∏è‚É£ V·ªõi m·ªói chi nh√°nh, l·∫•y inventory (t·ªìn kho t·∫•t c·∫£ s·∫£n ph·∫©m)<br>
      3Ô∏è‚É£ C·ªông d·ªìn s·ªë l∆∞·ª£ng t·ªìn kho c·ªßa t·ª´ng s·∫£n ph·∫©m t·ª´ t·∫•t c·∫£ chi nh√°nh<br>
      4Ô∏è‚É£ So s√°nh v·ªõi field `stock` ho·∫∑c `in_stock` t·ª´ API /products
    </div>
    
    <div style="margin: 20px 0;">
      <button onclick="testMethod1()">üîπ Method 1: L·∫•y inventory t·ª´ng chi nh√°nh</button>
      <button onclick="testMethod2()">üîπ Method 2: Test API /branches/:id/inventory/:productId</button>
      <button onclick="testCompareWithProducts()">üìä So s√°nh v·ªõi /products API</button>
      <button onclick="clearResults()">üóëÔ∏è Clear</button>
    </div>

    <div id="results"></div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:3000/api';
    const resultsDiv = document.getElementById('results');

    function clearResults() {
      resultsDiv.innerHTML = '';
    }

    function showLoading(message = 'ƒêang x·ª≠ l√Ω...') {
      resultsDiv.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p style="margin-top: 20px; color: #6b7280;">${message}</p>
        </div>
      `;
    }

    function log(title, data) {
      const section = document.createElement('div');
      section.innerHTML = `
        <h2>${title}</h2>
        <pre>${JSON.stringify(data, null, 2)}</pre>
      `;
      resultsDiv.appendChild(section);
    }

    function logError(title, error) {
      const section = document.createElement('div');
      section.innerHTML = `
        <h2>${title}</h2>
        <div class="error">‚ùå Error: ${error.message}</div>
      `;
      resultsDiv.appendChild(section);
    }

    function logSuccess(title, message) {
      const section = document.createElement('div');
      section.innerHTML = `
        <h2>${title}</h2>
        <div class="success">‚úÖ ${message}</div>
      `;
      resultsDiv.appendChild(section);
    }

    function displayStatsCards(stats) {
      return `
        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-label">T·ªïng s·ªë chi nh√°nh</div>
            <div class="stat-value">${stats.totalBranches}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">T·ªïng s·ªë s·∫£n ph·∫©m unique</div>
            <div class="stat-value">${stats.totalProducts}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">T·ªïng s·ªë l∆∞·ª£ng t·ªìn kho</div>
            <div class="stat-value">${stats.totalQuantity.toLocaleString()}</div>
          </div>
          <div class="stat-card" style="background: #fee2e2; border-color: #dc2626;">
            <div class="stat-label">S·∫£n ph·∫©m t·ªìn = 0</div>
            <div class="stat-value" style="color: #991b1b;">${stats.productsWithZeroStock}</div>
          </div>
        </div>
      `;
    }

    function displayProductTable(productsMap, title) {
      const products = Array.from(productsMap.values())
        .sort((a, b) => b.totalStock - a.totalStock)
        .slice(0, 50);

      if (products.length === 0) {
        return '<p class="warning">Kh√¥ng c√≥ d·ªØ li·ªáu s·∫£n ph·∫©m</p>';
      }

      const rows = products.map(p => `
        <tr>
          <td>${p.product_id}</td>
          <td>${p.product_name || 'N/A'}</td>
          <td class="${p.totalStock === 0 ? 'stock-zero' : 'stock-ok'}">
            ${p.totalStock.toLocaleString()}
          </td>
          <td>${p.branchCount}</td>
          <td style="font-size: 11px;">
            ${Object.entries(p.byBranch).map(([branchName, qty]) => 
              `${branchName}: <strong>${qty}</strong>`
            ).join('<br>')}
          </td>
        </tr>
      `).join('');

      return `
        <h3>${title}</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Product ID</th>
                <th>T√™n s·∫£n ph·∫©m</th>
                <th>T·ªïng t·ªìn kho</th>
                <th>S·ªë chi nh√°nh c√≥</th>
                <th>Chi ti·∫øt theo chi nh√°nh</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
        <p class="warning">‚ö†Ô∏è Ch·ªâ hi·ªÉn th·ªã 50 s·∫£n ph·∫©m c√≥ t·ªìn kho cao nh·∫•t</p>
      `;
    }

    async function testMethod1() {
      showLoading('ƒêang l·∫•y d·ªØ li·ªáu t·ª´ t·∫•t c·∫£ chi nh√°nh...');
      
      try {
        // Step 1: Get all branches
        const branchesRes = await fetch(`${API_BASE_URL}/branches?active=true`);
        const branchesData = await branchesRes.json();
        
        let branches = [];
        if (Array.isArray(branchesData.data)) {
          branches = branchesData.data;
        } else if (branchesData.data?.branches) {
          branches = branchesData.data.branches;
        } else if (branchesData.branches) {
          branches = branchesData.branches;
        }

        if (branches.length === 0) {
          resultsDiv.innerHTML = '<div class="error">Kh√¥ng t√¨m th·∫•y chi nh√°nh n√†o</div>';
          return;
        }

        resultsDiv.innerHTML = '';
        log('üè¢ Danh s√°ch chi nh√°nh', branches);

        // Step 2: Get inventory for each branch
        const productsMap = new Map();
        const branchNames = {};

        for (const branch of branches) {
          const branchId = branch.id || branch.branch_id;
          const branchName = branch.name || branch.branch_name || `Branch ${branchId}`;
          branchNames[branchId] = branchName;

          try {
            const inventoryRes = await fetch(`${API_BASE_URL}/branches/${branchId}/inventory`);
            const inventoryData = await inventoryRes.json();
            
            let items = [];
            if (Array.isArray(inventoryData)) {
              items = inventoryData;
            } else if (inventoryData.data?.inventory) {
              items = inventoryData.data.inventory;
            } else if (Array.isArray(inventoryData.data)) {
              items = inventoryData.data;
            }

            log(`üì¶ Inventory c·ªßa ${branchName} (${items.length} items)`, items.slice(0, 5));

            // Aggregate products
            items.forEach(item => {
              const productId = item.product_id;
              const quantity = item.quantity || item.stock || item.available_quantity || 0;
              const productName = item.product?.name || item.product?.product_name || item.product_name || `Product ${productId}`;

              if (!productsMap.has(productId)) {
                productsMap.set(productId, {
                  product_id: productId,
                  product_name: productName,
                  totalStock: 0,
                  branchCount: 0,
                  byBranch: {}
                });
              }

              const product = productsMap.get(productId);
              product.totalStock += quantity;
              product.byBranch[branchName] = quantity;
              product.branchCount++;
            });

          } catch (error) {
            console.error(`Error loading inventory for branch ${branchId}:`, error);
          }
        }

        // Step 3: Display results
        const stats = {
          totalBranches: branches.length,
          totalProducts: productsMap.size,
          totalQuantity: Array.from(productsMap.values()).reduce((sum, p) => sum + p.totalStock, 0),
          productsWithZeroStock: Array.from(productsMap.values()).filter(p => p.totalStock === 0).length
        };

        const section = document.createElement('div');
        section.innerHTML = `
          <h2>üìä K·∫øt qu·∫£ t·ªïng h·ª£p - Method 1: L·∫•y inventory t·ª´ng chi nh√°nh</h2>
          ${displayStatsCards(stats)}
          ${displayProductTable(productsMap, 'üìã Danh s√°ch s·∫£n ph·∫©m (Top 50)')}
        `;
        resultsDiv.appendChild(section);

        log('üìà Th·ªëng k√™ chi ti·∫øt', stats);

      } catch (error) {
        logError('‚ùå Error trong Method 1', error);
      }
    }

    async function testMethod2() {
      showLoading('ƒêang test API /branches/:id/inventory/:productId...');
      
      try {
        // Get first branch
        const branchesRes = await fetch(`${API_BASE_URL}/branches?active=true`);
        const branchesData = await branchesRes.json();
        
        let branches = [];
        if (Array.isArray(branchesData.data)) {
          branches = branchesData.data;
        } else if (branchesData.data?.branches) {
          branches = branchesData.data.branches;
        }

        if (branches.length === 0) {
          resultsDiv.innerHTML = '<div class="error">Kh√¥ng t√¨m th·∫•y chi nh√°nh n√†o</div>';
          return;
        }

        const firstBranch = branches[0];
        const branchId = firstBranch.id || firstBranch.branch_id;

        // Get inventory to find a product
        const inventoryRes = await fetch(`${API_BASE_URL}/branches/${branchId}/inventory?limit=5`);
        const inventoryData = await inventoryRes.json();
        
        let items = [];
        if (Array.isArray(inventoryData)) {
          items = inventoryData;
        } else if (inventoryData.data?.inventory) {
          items = inventoryData.data.inventory;
        } else if (Array.isArray(inventoryData.data)) {
          items = inventoryData.data;
        }

        if (items.length === 0) {
          resultsDiv.innerHTML = '<div class="error">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o trong kho</div>';
          return;
        }

        resultsDiv.innerHTML = '';

        // Test API for first 3 products
        for (let i = 0; i < Math.min(3, items.length); i++) {
          const productId = items[i].product_id;
          
          try {
            const url = `${API_BASE_URL}/branches/${branchId}/inventory/${productId}`;
            const response = await fetch(url);
            const data = await response.json();
            
            log(`‚úÖ API Response: /branches/${branchId}/inventory/${productId}`, data);
          } catch (error) {
            logError(`‚ùå Error for product ${productId}`, error);
          }
        }

        const section = document.createElement('div');
        section.innerHTML = `
          <div class="info">
            <strong>‚úÖ K·∫øt lu·∫≠n:</strong><br>
            API <code>/branches/:branchId/inventory/:productId</code> ${items.length > 0 ? 'ho·∫°t ƒë·ªông t·ªët' : 'c√≥ v·∫•n ƒë·ªÅ'}.<br>
            C√≥ th·ªÉ d√πng API n√†y ƒë·ªÉ l·∫•y t·ªìn kho c·ªßa 1 s·∫£n ph·∫©m t·∫°i 1 chi nh√°nh c·ª• th·ªÉ.
          </div>
        `;
        resultsDiv.appendChild(section);

      } catch (error) {
        logError('‚ùå Error trong Method 2', error);
      }
    }

    async function testCompareWithProducts() {
      showLoading('ƒêang so s√°nh d·ªØ li·ªáu v·ªõi /products API...');
      
      try {
        // Get products from /products API
        const productsRes = await fetch(`${API_BASE_URL}/products?page=1&limit=100`);
        const productsData = await productsRes.json();
        
        let productsFromAPI = [];
        if (Array.isArray(productsData)) {
          productsFromAPI = productsData;
        } else if (productsData.data?.products) {
          productsFromAPI = productsData.data.products;
        } else if (productsData.products) {
          productsFromAPI = productsData.products;
        }

        // Get branches
        const branchesRes = await fetch(`${API_BASE_URL}/branches?active=true`);
        const branchesData = await branchesRes.json();
        
        let branches = [];
        if (Array.isArray(branchesData.data)) {
          branches = branchesData.data;
        } else if (branchesData.data?.branches) {
          branches = branchesData.data.branches;
        }

        // Calculate total stock from branches
        const calculatedStockMap = new Map();

        for (const branch of branches) {
          const branchId = branch.id || branch.branch_id;
          
          const inventoryRes = await fetch(`${API_BASE_URL}/branches/${branchId}/inventory`);
          const inventoryData = await inventoryRes.json();
          
          let items = [];
          if (Array.isArray(inventoryData)) {
            items = inventoryData;
          } else if (inventoryData.data?.inventory) {
            items = inventoryData.data.inventory;
          } else if (Array.isArray(inventoryData.data)) {
            items = inventoryData.data;
          }

          items.forEach(item => {
            const productId = item.product_id;
            const quantity = item.quantity || item.stock || item.available_quantity || 0;
            
            if (!calculatedStockMap.has(productId)) {
              calculatedStockMap.set(productId, 0);
            }
            calculatedStockMap.set(productId, calculatedStockMap.get(productId) + quantity);
          });
        }

        resultsDiv.innerHTML = '';

        // Compare
        const comparisonResults = productsFromAPI.slice(0, 20).map(product => {
          const productId = product.id;
          const stockFromAPI = product.total_stock ?? product.stock ?? 0;
          const calculatedStock = calculatedStockMap.get(productId) || 0;
          const match = stockFromAPI === calculatedStock;

          return {
            id: productId,
            name: product.name,
            total_stock_from_api: product.total_stock,
            stock_from_api: product.stock,
            in_stock_from_api: product.in_stock,
            calculated_stock: calculatedStock,
            difference: calculatedStock - stockFromAPI,
            match: match ? '‚úÖ' : '‚ùå'
          };
        });

        const matchCount = comparisonResults.filter(r => r.match === '‚úÖ').length;
        const mismatchCount = comparisonResults.filter(r => r.match === '‚ùå').length;

        const section = document.createElement('div');
        section.innerHTML = `
          <h2>üìä So s√°nh: /products API vs T√≠nh to√°n t·ª´ branches</h2>
          <div class="stat-grid">
            <div class="stat-card" style="background: #d1fae5; border-color: #10b981;">
              <div class="stat-label">Kh·ªõp d·ªØ li·ªáu</div>
              <div class="stat-value" style="color: #065f46;">${matchCount}</div>
            </div>
            <div class="stat-card" style="background: #fee2e2; border-color: #dc2626;">
              <div class="stat-label">Kh√¥ng kh·ªõp</div>
              <div class="stat-value" style="color: #991b1b;">${mismatchCount}</div>
            </div>
          </div>
        `;
        resultsDiv.appendChild(section);

        log('üìã Chi ti·∫øt so s√°nh (20 s·∫£n ph·∫©m ƒë·∫ßu)', comparisonResults);

        const conclusionDiv = document.createElement('div');
        if (mismatchCount > matchCount) {
          conclusionDiv.innerHTML = `
            <div class="error">
              <strong>‚ùå K·∫æT LU·∫¨N:</strong><br>
              Field <code>total_stock</code> ho·∫∑c <code>stock</code> trong API /products <strong>KH√îNG ch√≠nh x√°c</strong>.<br>
              <strong>Gi·∫£i ph√°p:</strong> C·∫ßn t√≠nh t·ªïng t·ªìn kho b·∫±ng c√°ch c·ªông t·ª´ t·∫•t c·∫£ c√°c chi nh√°nh th√¥ng qua API /branches/:id/inventory<br><br>
              <strong>üí° L∆∞u √Ω:</strong><br>
              - <code>total_stock</code>: T·ªïng s·ªë l∆∞·ª£ng t·ªìn kho (d√πng cho admin/staff)<br>
              - <code>in_stock</code>: Boolean true/false (d√πng cho customer - c√≥ h√†ng/h·∫øt h√†ng)<br>
              - <code>stock</code>: Deprecated field (kh√¥ng n√™n d√πng)
            </div>
          `;
        } else {
          conclusionDiv.innerHTML = `
            <div class="success">
              <strong>‚úÖ K·∫æT LU·∫¨N:</strong><br>
              Field <code>total_stock</code> trong API /products <strong>ch√≠nh x√°c</strong>.<br>
              C√≥ th·ªÉ s·ª≠ d·ª•ng tr·ª±c ti·∫øp t·ª´ API /products<br><br>
              <strong>üí° L∆∞u √Ω:</strong><br>
              - <code>total_stock</code>: T·ªïng s·ªë l∆∞·ª£ng t·ªìn kho (d√πng cho admin/staff)<br>
              - <code>in_stock</code>: Boolean true/false (d√πng cho customer - c√≥ h√†ng/h·∫øt h√†ng)
            </div>
          `;
        }
        resultsDiv.appendChild(conclusionDiv);

      } catch (error) {
        logError('‚ùå Error khi so s√°nh', error);
      }
    }
  </script>
</body>
</html>
